---
title: "Functional Connectivity Networks' Topology Changes after rTMS in Cocaine Addiction 2.0"
subtitle: "Electric Boogaloo"
author: "Sofia Fernandez"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output:
  bookdown::pdf_document2:
    fig_caption: yes
    keep_md: yes
---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.width = 8, collapse = TRUE)

library(data.table)
library(readr)
library(here)
library(arsenal)
library(afex)
library(lme4)
library(stargazer)
library(ggplot2)
library(gghalves)
library(ggthemes)
library(ggrepel)
library(extrafont)
library(latex2exp)

ffont  <- "Merriweather"
```

# Introduction

In this report I present and analyse the data of the ADDIMEX_TMS project.
For the project, participants diagnosed with Cocaine Use Disorder (CUD)
volunteered to take part into a double-blind randomized clinical trial
(Active/Sham) exploring the efficacy of rTMS diminishing the clinical symptoms
of addiction.

Participants were randomly assigned to receive two daily sessions of either
active or sham rTMS over the left-DLPFC for two weeks (10 weekdays).
This consisted in the **closed-label** phase of the study.
After the last day of treatment the group assignment was revealed.
To those of the sham arm we offered to retake 20 more sessions of real rTMS
under the same parameters as the active group.

We acquired both clinical and MRI data at Baseline (T0), two weeks (T1), three
(T2) and six (T3) months. For this **longitudinal phase** only the participants
who started with active stimulation were included in the analysis.

Here I explore the brain functional connectivity of the participants in the
form of global networks constructed from the BOLD signal of their MRI data.
Different metrics of topology are calculated and compared at the different
time-points to see how they are affected by the treatment in the closed-label,
and how they evolve over time in the Longitudinal phase.

# Demographics and Clinical data

```{r rds-data}
covars <- read_rds(here("data/processed/rds/clin+covars.rds"))
setkey(covars, participant_id, session, group)
att.G <- read_rds(here("data/processed/rds/g_vars_G.rds"))
setkey(att.G, participant_id, session, group)
# This is running. For now is identical to full graph metrics
att.V <- read_rds(here("data/processed/rds/g_vars_V.rds"))
setkey(att.V, participant_id, session, group)
```

```{r derivated-data}
gdata     <- covars[att.G]

metrics   <- c("density", "strength", "mod.wt", "num.hubs.wt", "E.global.wt",
               "E.local.wt", "E.local", "E.global")
## No SW atts yet
dems      <- c("participant_id", "session", "group")
clins     <- c("bis", "bis_c", "bis_m", "bis_n", "vas", "ccq_n", "ccq_g")

## Will use this or subset manually?
nets      <- c("threshold", "thresh.method", "global_signal", "atlas")

## WTF was I doing with this?? Subsetting?? Is super messy/confusing
##colms     <- c(dems, metrics)
##colms2    <- c(dems[-4], clins)
##colms3    <- c(dems, metrics, clins, "FD", "Age", "Sex")
##colms4    <- c(dems[1:2], clins)
##colms5    <- c(dems[-3], metrics)
##colms6    <- c(dems[-3], metrics, clins, "FD", "Age", "Sex")
#### Check when used to put in there... Better for later
##gdmod    <- gdata[Session %in% c("T0", "T1"), ..colms3]
##gdmod2   <- gdlong[, ..colms6]
```

## Demographics

After baseline criteria filtering and subsequent exclusion, 50 participants
were randomly assigned to a group and went through baseline data acquisition.

Table \@ref(tab:demog-table) contains a summary of the demographics of these 50 participants initially enrolled.

```{r demog-table, results="asis"}
### Change some levels... Really needed?
# levels(covars$sex)      <- c("Male", "Female")
# levels(covars$tx)[2:3]  <- c("Psych & Pharm", "Pharm")

# Change some labels
labels(covars) <- c(
  age         = "Age (years)",
  educ        = "Education (years)",
  civ         = "Civil status",
  employment  = "Employment (last 3 y)",
  substance   = "Main substance",
  tobacco     = "Smoking",
  cigs_day    = "Cigarettes/day",
  tx          = "Treatment",
  y_start     = "Onset age of cocaine use",
  t_cons      = "Years of cocaine use"
)

# Table
t1 <- tableby(group ~ sex + age + educ + civ + employment + tobacco +
              tobacco_years + cigs_day + substance + tx + y_start + t_cons,
  data = covars[session == "T0"],
  test = FALSE)

summary(t1, title = "(\\#tab:demog-table) Demographic data at baseline", digits = 1)
```

## Dropouts

One of the main drawbacks of the project was the high number of dropouts
throughout the data-acquisition phases. A lot of data would be lost due to
dropouts; six participants didn't complete the two weeks of treatment and only
13 stayed in the program until the six-months time-point.

Most of the analyses are done through mixed-effect models which are robust to
missing data. This allows to maintain the data of those subjects who subsequently
dropped out of the study.

## Covariates

### Clinical data as covariates
The clinical data has already been explored and compared both by the
experimental groups and longitudinally through the different time-points in
another manuscript. For this reason, in this report I focus only in those
variables that showed significant interaction, and their purpose is mainly as covariates for the network analyses.

### In-scanner movement
Head-motion is one of the main sources for artefacts in functional MRI data.
Although some of the noise related to motion can be removed at the
pre-processing steps; residual artefacts can still remain in cases of elevated
motion, especially when dealing with patient populations. Because of this,
frame-wise displacement is treated as a covariate in the models.

## Clinical Data

### Acute phase

In table \@ref(tab:summary-acute) are summarized by experimental group and
session (before and after treatment) the main clinical variables, self-report of consumption (frequency and weight) and in-scanner head movement.

The clinical scores of craving (Viusal Analog Scale) and impulsivity at this
stage are represented in figure \@ref(fig:acute-clin).

```{r summary-acute, results = "asis"}
# Labels
labels(covars)   <- c(
  bis          = "BIS-11",
  bis_c        = "BIS-11 Cognitive",
  bis_m        = "BIS-11 Motor",
  bis_n        = "BIS-11 Non-planning",
  vas          = "Visual Analog Scale",
  ccq_n        = "CCQ-Now",
  ccq_g        = "CCQ-General",
  cons_freq    = "Consumption (freq)",
  cons_grams   = "Consumption (g)",
  fd           = "In-scanner movement (mm)"
)

# Table
t2 <- tableby(session ~ sex + age + cons_freq + cons_grams + relapse + status +
  bis + vas + fd,
  data = covars[session %in% c("T0", "T1")],
  strata = group,
  total = FALSE,
  test = FALSE)

summary(t2, title = "(\\#tab:summary-acute) Clinical summary of acute phase", digits = 1)
```

```{r acute-clin, fig.cap = "Clinical scores by experimental group in the acute phase. A) Craving scores by VAS & B) Impulsivity by BIS-11."}
# colms2: dems [-thresh] + clins
columns   <- c(dems, clins)
## WTF is gdp??? CHANGE TO A BETTER NAME... later
gdpclin   <- covars[session %in% c("T0", "T1"), ..columns]

source(here("scripts/raincloudplots.R"))
colrs <- c("#00429d", "#93003a")

vas2x2 <- gdpclin[, .(y_axis = vas, id = participant_id, s = session, group)]
vas2x2[s == "T0", x_axis := 1 ][ s == "T1", x_axis := 2][
  group == "Real", x_axis := x_axis + 0.01][  ## Change to 2 for double x axis
  , jit := jitter(x_axis, amount = .1)]

p1 <- rc_repmes_2x2(vas2x2, fills = colrs, colors = colrs,
                    groups = c("Sham", "Real")) +
  scale_x_continuous(breaks = c(1,2), labels = c("Pre", "Post"),
                     limits = c(0.4,2.6)) +
  guides(col = FALSE) +
  labs(y = "VAS Total") +
  theme_tufte(base_size = 24) +
  theme(text = element_text(size = 24, family = ffont),
        axis.title.x = element_blank(),
        axis.ticks = element_blank())

bis2x2 <- gdpclin[, .(y_axis = bis, id = participant_id, s = session, group)]
bis2x2[s == "T0", x_axis := 1 ][ s == "T1", x_axis := 2][
  group == "Real", x_axis := x_axis + 0.01][  ## Change to 2 for double x axis
  , jit := jitter(x_axis, amount = .1)]

p2 <- rc_repmes_2x2(bis2x2, fills = colrs, colors = colrs,
                    groups = c("Sham", "Real")) +
  scale_x_continuous(breaks = c(1,2), labels = c("Pre", "Post"),
                     limits = c(0.4,2.6)) +
  guides(col = FALSE) +
  labs(y = "BIS Total") +
  theme_tufte(base_size = 24) +
  theme(text = element_text(size = 24, family = ffont),
        axis.title.x = element_blank(),
        axis.ticks = element_blank())

cowplot::plot_grid(p1, p2, labels = "AUTO", label_size = 32, nrow = 2)
```

### Maintenance phase

To explore the longitudinal changes observed by the rTMS treatment, the stages
of those participants initially in the sham arm were recoded to take into account
the firs two weeks of simulated stimulation preceding the active treatment.
In those subjects, the data acquired at baseline were relabelled as **T-1**;
the data obtained followint the end of the acute phase, and thus preceding real
treatment was then **T0**, and the stage following the the two weeks of active
stimulation **T1**.

The labels for the maintenance phase are the same for both arms.

Main clinical data for all participants with this recoding are summarized in
table \@ref(tab:summary-maintenance) and the clinical changes for craving and
impulsivity are represented in figure \@ref(fig:long-clin).

```{r summary-maintenance, results = "asis"}
t3 <- tableby(session ~ sex + age + cons_freq + cons_grams + relapse + status +
  bis + vas + fd,
  data = covars[group == "Real"],
  total = FALSE,
  test = FALSE)

summary(t3, title = "(\\#tab:summary-maintenance) Clinical summary of maintenance phase", digits = 1)
```

```{r long-clin, fig.cap = "Clinical scores across all stages: A) Craving scores by VAS & B) Impulsivity by BIS-11."}

columns <- c(dems[-3], clins)
gdclinl <- covars[group == "Real", ..columns]

colrsl <- c("#00429d", "#35739a", "#c8004c", "#93003a")

vasl <- gdclinl[, .(y_axis = vas, id = participant_id, s = session)]
vasl[s == "T0", x_axis := 1 ][ s == "T1", x_axis := 2][s == "T2", x_axis :=3][
  s == "T3", x_axis := 4][, jit := jitter(x_axis, amount = .09)]

p3 <- rc_repmes(vasl, times = 4, fills = colrsl, colors = colrsl) +
  scale_x_continuous(breaks = c(1:4), labels = unique(covarsl[,session]),
                     limits = c(0.9,4.8)) +
  labs(y = "VAS Total") +
  theme_tufte(base_size = 24) +
  theme(text = element_text(size = 24, family = ffont),
        axis.title.x = element_blank(),
        axis.ticks = element_blank())

bisl <- gdclinl[, .(y_axis = bis, id = participant_id, s = session)]
bisl[s == "T0", x_axis := 1 ][ s == "T1", x_axis := 2][s == "T2", x_axis :=3][
  s == "T3", x_axis := 4][, jit := jitter(x_axis, amount = .09)]

p4 <- rc_repmes(bisl, times = 4, fills = colrsl, colors = colrsl) +
  scale_x_continuous(breaks = c(1:4), labels = unique(covarsl[,session]),
                     limits = c(0.9,4.8)) +
  labs(y = "BIS Total") +
  theme_tufte(base_size = 24) +
  theme(text = element_text(size = 24, family = ffont),
        axis.title.x = element_blank(),
        axis.ticks = element_blank())

cowplot::plot_grid(p3, p4, labels = "AUTO", label_size = 32, nrow = 2)
```

# Acute phase

```{r sparklines-acute, fig.cap = "Sparklines of the topology metrics across thresholds. Labels: Max and Min; Grey shadow: IQR.", fig.height = 9}
##Subset specific atlas/thresholding/gs
#Power/raw/gs
setnames(gdata, c("threshold", "thresh.method", "global_signal", "atlas"),
         c("t", "t.m", "gs", "a"))
gdata  <- gdata[a == "power264" & t.m == "raw" & gs == "gs",
                -c("a", "t.m", "gs")]

columns <- c(dems, "t", metrics)
gdl <- data.table::melt(gdata[session %in% c("T0", "T1"), ..columns],
                              id.vars = c(dems, 't'), measure.vars = metrics,
                              variable.name = "metric", value.name = "val")

#Extract means, mins, max and quartiles
gdmean <- gdl[, .(val = mean(val)), by = .(group, session, t, metric)]
gdmin <- gdmean[, .SD[which.min(val)], keyby = .(group, session, metric)]
gdmax <- gdmean[, .SD[which.max(val)], keyby = .(group, session, metric)]
gdmin[, val.r := round(val, 2)]
gdmax[, val.r := round(val, 2)]
gdlabs <- unique(gdmin, by = c("group", "val", "metric"))
gdlabs[, l := "Min"]
gdlabs2 <- unique(gdmax, by = c("group", "val", "metric"))
gdlabs2[, l := "Max"]
gdlabs <- rbindlist(list(gdlabs, gdlabs2))
gdquarts <- gdmean[,.(quart1 = quantile(val, 0.25), quart2 = quantile(val, 0.75)), by = .(group, metric)]
setkey(gdmean, group, metric)
gdquarts <- gdmean[gdquarts]

#Sparklines
##Repeat with different atlas/parcelations and gs/ngs
ggplot(gdmean, aes(x = t, y = val, colour = session)) +
  facet_grid(vars(metric), vars(group), scales = "free_y") +
  geom_ribbon(data = gdquarts,
              aes(ymin = quart1, ymax = quart2, colour = NULL),
              fill = "grey93", alpha = 0.75) +
  geom_line(size = 0.5) +
  geom_point(data = gdlabs, shape = 21, size = 2, fill = "white") +
  geom_label_repel(data = gdlabs, aes(label = val.r), family = ffont,
                   size = 3, force = 1.3, label.padding = 0.1,
                   min.segment.length = 0, segment.size = .2,
                   segment.alpha = 0.7, alpha = 0.7) +
  scale_x_continuous(bquote(tau),breaks = seq(0, .4, .1)) +
  scale_y_continuous(expand = c(0.1, 0)) +
  scale_colour_manual(values = c("#00429d","#93003a")) +
  ggtitle("Power264; Raw; wGS") +
  theme(text = element_text(size = 24, family = ffont)) +
  theme_tufte(base_size = 24, base_family = ffont) +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        strip.text.y = element_text(angle = 0))
```

```{r integrals}
columns <- c(dems, 't', metrics)
gdw  <- gdata[session %in% c("T0", "T1"), ..columns]

gdints <- gdw[, lapply(.SD, MESS::auc, x = t, type = 'spline'),
              by = .(participant_id, session, group), .SDcols = metrics]
```

## Density

```{r repmes-density, fig.cap = "Integrated metric of density by group."}
dens2x2 <- gdints[, .(y_axis = density, id = participant_id, s = session, group)]
dens2x2[
  s == "T0", x_axis := 1 ][
  s == "T1", x_axis := 2][
  group == "Real", x_axis := x_axis + 0.01][  ## Change to 2 for double x axis
  , jit := jitter(x_axis, amount = .1)]

rc_repmes_2x2(dens2x2, fills = colrs, colors = colrs,
              groups = c("Sham", "Real")) +
  scale_x_continuous(breaks = c(1,2), labels = c("Pre", "Post"),
                     limits = c(0.4, 2.6)) +
  guides(col = FALSE) +
  ylab(TeX("$\\int_{0.02}^{0.4} density (\\tau) d_{\\tau}")) +
  theme_tufte(base_size = 24) +
  theme(axis.title.x = element_blank(),
  axis.ticks = element_blank())
```

### Likelihood Ratio Test of Fixed effects

```{r lrt-density}
columns <- c(dems, "age", "sex", clins, "fd", 't', metrics)
dt.mod <- gdata[session %in% c("T0", "T1"), ..columns]
mixed(density ~ session*group + fd + vas + bis + age + sex +
                   (1 + session|participant_id) + (1|t),
                 data = dt.mod, method = 'LRT')
```

### Mixed effect model

```{r lmer-density, results = "asis"}
mod <- lme4::lmer(density ~ session*group + fd + sex +
                  (1+session|participant_id) + (1|t), data = dt.mod)

##Merge tables of mixed models???
stargazer(mod, header = FALSE,
          title = "(\\#tab:lmer-density) Mixed Effects Model for Density.")
```

## Strength

```{r repmes-strength, fig.cap = "Integrated metric of strength by group."}
strength2x2 <- gdints[,
  .(y_axis = strength, id = participant_id, s = session, group)]

strength2x2[
  s == "T0", x_axis := 1 ][
  s == "T1", x_axis := 2][
  group == "Real", x_axis := x_axis + 0.01][  ## Change to 2 for double x axis
  , jit := jitter(x_axis, amount = .1)]

rc_repmes_2x2(strength2x2, fills = colrs, colors = colrs,
              groups = c("Sham", "Real")) +
  scale_x_continuous(breaks = c(1,2), labels = c("Pre", "Post"),
                     limits = c(0.4, 2.6)) +
  guides(col = FALSE) +
  ylab(TeX("$\\int_{0.02}^{0.4} strength (\\tau) d_{\\tau}")) +
  theme_tufte(base_size = 24) +
  theme(axis.title.x = element_blank(),
  axis.ticks = element_blank())
```

### Likelihood Ratio Test

```{r lrt-strength}
columns <- c(dems, "age", "sex", clins, "fd", 't', metrics)
dt.mod <- gdata[session %in% c("T0", "T1"), ..columns]
mixed(strength ~ session*group + fd + vas + bis + age + sex +
                   (1 + session|participant_id) + (1|t),
                 data = dt.mod, method = 'LRT')
```

### Mixed effect model

```{r lmer-strength, results = "asis"}
mod <- lme4::lmer(strength ~ session*group + fd + sex +
                  (1+session|participant_id) + (1|t), data = dt.mod)

stargazer(mod, header = FALSE,
          title = "(\\#tab:lmer-strength) Mixed Effects Model for Strength.")
```

## Modularity

```{r repmes-mod, fig.cap = "Integrated metric of modularity by group."}
mod2x2 <- gdints[,
  .(y_axis = mod.wt, id = participant_id, s = session, group)]

mod2x2[
  s == "T0", x_axis := 1 ][
  s == "T1", x_axis := 2][
  group == "Real", x_axis := x_axis + 0.01][  ## Change to 2 for double x axis
  , jit := jitter(x_axis, amount = .1)]

rc_repmes_2x2(mod2x2, fills = colrs, colors = colrs,
              groups = c("Sham", "Real")) +
  scale_x_continuous(breaks = c(1,2), labels = c("Pre", "Post"),
                     limits = c(0.4, 2.6)) +
  guides(col = FALSE) +
  ylab(TeX("$\\int_{0.02}^{0.4} mod.wt (\\tau) d_{\\tau}")) +
  theme_tufte(base_size = 24) +
  theme(axis.title.x = element_blank(),
  axis.ticks = element_blank())
```

### Likelihood Ratio Test

```{r lrt-mod}
columns <- c(dems, "age", "sex", clins, "fd", 't', metrics)
dt.mod <- gdata[session %in% c("T0", "T1"), ..columns]
mixed(mod.wt ~ session*group + fd + vas + bis + age + sex +
                   (1 + session|participant_id) + (1|t),
                 data = dt.mod, method = 'LRT')
```

### Mixed effect model

```{r lmer-mod, results = "asis"}
mod <- lme4::lmer(mod.wt ~ session*group + fd + sex +
                  (1+session|participant_id) + (1|t), data = dt.mod)

stargazer(mod, header = false,
          title = "(\\#tab:lmer-mod) mixed effects model for modularity.")
```


## Number of hubs

```{r repmes-nhubs, fig.cap = "Integrated metric of the number of hubs by group."}
nhubs2x2 <- gdints[,
  .(y_axis = num.hubs.wt, id = participant_id, s = session, group)]

nhubs2x2[
  s == "T0", x_axis := 1 ][
  s == "T1", x_axis := 2][
  group == "Real", x_axis := x_axis + 0.01][  ## Change to 2 for double x axis
  , jit := jitter(x_axis, amount = .1)]

rc_repmes_2x2(nhubs2x2, fills = colrs, colors = colrs,
              groups = c("Sham", "Real")) +
  scale_x_continuous(breaks = c(1,2), labels = c("Pre", "Post"),
                     limits = c(0.4, 2.6)) +
  guides(col = FALSE) +
  ylab(TeX("$\\int_{0.02}^{0.4} n.hubs.wt (\\tau) d_{\\tau}")) +
  theme_tufte(base_size = 24) +
  theme(axis.title.x = element_blank(),
  axis.ticks = element_blank())
```

### Likelihood Ratio Test

```{r lrt-nhubs}
columns <- c(dems, "age", "sex", clins, "fd", 't', metrics)
dt.mod <- gdata[session %in% c("T0", "T1"), ..columns]
mixed(num.hubs.wt ~ session*group + fd + vas + bis + age + sex +
                   (1 + session|participant_id) + (1|t),
                 data = dt.mod, method = 'LRT')
```

### Mixed effect model

```{r lmer-nhubs, results = 'asis'}
mod <- lme4::lmer(num.hubs.wt ~ session*group + fd + sex +
                  (1+session|participant_id) + (1|t), data = dt.mod)

stargazer(mod, header = false,
          title = "(\\#tab:lmer-nhubs) mixed effects model for number of hubs.")
```

## Global efficiency

```{r repmes-eglob, fig.cap = "Integrated metric of global efficiency by group."}
eglob2x2 <- gdints[,
  .(y_axis = E.global, id = participant_id, s = session, group)]

eglob2x2[
  s == "T0", x_axis := 1 ][
  s == "T1", x_axis := 2][
  group == "Real", x_axis := x_axis + 0.01][  ## Change to 2 for double x axis
  , jit := jitter(x_axis, amount = .1)]

rc_repmes_2x2(eglob2x2, fills = colrs, colors = colrs,
              groups = c("Sham", "Real")) +
  scale_x_continuous(breaks = c(1,2), labels = c("Pre", "Post"),
                     limits = c(0.4, 2.6)) +
  guides(col = FALSE) +
  ylab(TeX("$\\int_{0.02}^{0.4} E.global (\\tau) d_{\\tau}")) +
  theme_tufte(base_size = 24) +
  theme(axis.title.x = element_blank(),
  axis.ticks = element_blank())
```

### Likelihood Ratio Test

```{r lrt-eglob}
columns <- c(dems, "age", "sex", clins, "fd", 't', metrics)
dt.mod <- gdata[session %in% c("T0", "T1"), ..columns]
mixed(E.global ~ session*group + fd + vas + bis + age + sex +
                   (1 + session|participant_id) + (1|t),
                 data = dt.mod, method = 'LRT')
```

### Mixed effect model

```{r lmer-eglob, results = "asis"}
mod <- lme4::lmer(E.global ~ session*group + fd + sex +
                  (1+session|participant_id) + (1|t), data = dt.mod)

stargazer(mod, header = false,
          title = "(\\#tab:lmer-ge) mixed effects model for Global Efficiency.")
```

## Global efficiency (weighted)

```{r repmes-eglobw, fig.cap = "Integrated metric of global efficiency by group (weighted)."}
eglobw2x2 <- gdints[,
  .(y_axis = E.global.wt, id = participant_id, s = session, group)]

eglobw2x2[
  s == "T0", x_axis := 1 ][
  s == "T1", x_axis := 2][
  group == "Real", x_axis := x_axis + 0.01][  ## Change to 2 for double x axis
  , jit := jitter(x_axis, amount = .1)]

rc_repmes_2x2(eglobw2x2, fills = colrs, colors = colrs,
              groups = c("Sham", "Real")) +
  scale_x_continuous(breaks = c(1,2), labels = c("Pre", "Post"),
                     limits = c(0.4, 2.6)) +
  guides(col = FALSE) +
  ylab(TeX("$\\int_{0.02}^{0.4} E.global.wt (\\tau) d_{\\tau}")) +
  theme_tufte(base_size = 24) +
  theme(axis.title.x = element_blank(),
  axis.ticks = element_blank())
```

### Likelihood Ratio Test

```{r lrt-eglobw}
columns <- c(dems, "age", "sex", clins, "fd", 't', metrics)
dt.mod <- gdata[session %in% c("T0", "T1"), ..columns]
mixed(E.global.wt ~ session*group + fd + vas + bis + age + sex +
                   (1 + session|participant_id) + (1|t),
                 data = dt.mod, method = 'LRT')
```

### Mixed effect model

```{r lmer-eglobw, results = "asis"}
mod <- lme4::lmer(E.global.wt ~ session*group + fd + sex +
                  (1+session|participant_id) + (1|t), data = dt.mod)

stargazer(mod, header = false,
          title = "(\\#tab:lmer-gew) mixed effects model for Global Efficiency (weighted).")
```

## Local efficiency

```{r repmes-eloc, fig.cap = "Integrated metric of local efficiency by group."}
eloc2x2 <- gdints[,
  .(y_axis = E.local, id = participant_id, s = session, group)]

eloc2x2[
  s == "T0", x_axis := 1 ][
  s == "T1", x_axis := 2][
  group == "Real", x_axis := x_axis + 0.01][  ## Change to 2 for double x axis
  , jit := jitter(x_axis, amount = .1)]

rc_repmes_2x2(eloc2x2, fills = colrs, colors = colrs,
              groups = c("Sham", "Real")) +
  scale_x_continuous(breaks = c(1,2), labels = c("Pre", "Post"),
                     limits = c(0.4, 2.6)) +
  guides(col = FALSE) +
  ylab(TeX("$\\int_{0.02}^{0.4} E.local (\\tau) d_{\\tau}")) +
  theme_tufte(base_size = 24) +
  theme(axis.title.x = element_blank(),
  axis.ticks = element_blank())
```

### Likelihood Ratio Test

```{r lrt-eloc}
columns <- c(dems, "age", "sex", clins, "fd", 't', metrics)
dt.mod <- gdata[session %in% c("T0", "T1"), ..columns]
mixed(E.local ~ session*group + fd + vas + bis + age + sex +
                   (1 + session|participant_id) + (1|t),
                 data = dt.mod, method = 'LRT')
```

### Mixed effect model

```{r lmer-eloc, results = "asis"}
mod <- lme4::lmer(E.local ~ session*group + fd + sex +
                  (1+session|participant_id) + (1|t), data = dt.mod)

stargazer(mod, header = false,
          title = "(\\#tab:lmer-eloc) mixed effects model for Local Efficiency.")
```

## Local efficiency (weighted)

```{r repmes-elocw, fig.cap = "Integrated metric of local efficicency (weighted) by group."}
elocw2x2 <- gdints[,
  .(y_axis = E.local.wt, id = participant_id, s = session, group)]

elocw2x2[
  s == "T0", x_axis := 1 ][
  s == "T1", x_axis := 2][
  group == "Real", x_axis := x_axis + 0.01][  ## Change to 2 for double x axis
  , jit := jitter(x_axis, amount = .1)]

rc_repmes_2x2(elocw2x2, fills = colrs, colors = colrs,
              groups = c("Sham", "Real")) +
  scale_x_continuous(breaks = c(1,2), labels = c("Pre", "Post"),
                     limits = c(0.4, 2.6)) +
  guides(col = FALSE) +
  ylab(TeX("$\\int_{0.02}^{0.4} E.local.wt (\\tau) d_{\\tau}")) +
  theme_tufte(base_size = 24) +
  theme(axis.title.x = element_blank(),
  axis.ticks = element_blank())
```

### Likelihood Ratio Test

```{r lrt-elocw}
columns <- c(dems, "age", "sex", clins, "fd", 't', metrics)
dt.mod <- gdata[session %in% c("T0", "T1"), ..columns]
mixed(E.local.wt ~ session*group + fd + vas + bis + age + sex +
                   (1 + session|participant_id) + (1|t),
                 data = dt.mod, method = 'LRT')
```

```{r lmer-elocw, results= "asis"}
mod <- lme4::lmer(E.local.wt ~ session*group + fd + sex +
                  (1+session|participant_id) + (1|t), data = dt.mod)

stargazer(mod, header = false,
          title = "(\\#tab:lmer-elocw) mixed effects model for Local Efficiency (weighted).")
```

# Maintenance phase

```{r sparklines-long, fig.cap = "Sparklines of the topology metrics across thresholds in the maintenance phase. Labels: Max and Min; Grey shadow: IQR.", fig.height = 9}
# Reshape to Long
gdl2   <- data.table::melt(gdlong[, ..colms5],
                              id.vars = dems[-3], measure.vars = metrics,
                              variable.name = "Metric", value.name = "Val")
setkey(gdl2, Metric, Session)

# Extract means, mins, max and quartiles
gdmean2    <- gdl2[, .(Val = mean(Val)),
                    by = .(threshold, Metric, Session)]
setkey(gdmean2, Metric, Session)
gdmin2     <- gdmean2[, .SD[which.min(Val)], keyby = .(Metric, Session)]
gdmax2     <- gdmean2[, .SD[which.max(Val)], keyby = .(Metric, Session)]
gdmin2[, Val := round(Val, 2)]
gdmax2[, Val := round(Val, 2)]
# gdlabs3    <- unique(gdmin2, by = c("Metric", "Val"))
gdmin2[, l := "Min"]
# gdlabs4    <- unique(gdmax2, by = c("Metric", "Val"))
gdmax2[, l := "Max"]
gdlabs3    <- rbindlist(list(gdmin2, gdmax2))
gdquarts2  <- gdmean2[gdmean2[,.(quart1 = quantile(Val, 0.25),
                              quart2 = quantile(Val, 0.75)),
                            by = .(Metric)]]

# Sparklines
ggplot(gdmean2, aes(x = threshold, y = Val, colour = Session)) +
  facet_wrap(vars(Metric), ncol = 4, scales = "free_y") +
  geom_ribbon(data = gdquarts2,
              aes(ymin = quart1, ymax = quart2, colour = NULL),
              fill = "grey93", alpha = 0.75) +
  geom_line(size = 0.3) +
  geom_point(data = gdlabs3, shape = 21, size = 1.5,
             fill = "white") +
  geom_label_repel(data = gdlabs3, aes(label = Val),
                   family = ffont, size = 2, force = 1.3, label.padding = 0.1,
                   min.segment.length = 0, segment.size = .2,
                   segment.alpha = 0.7, alpha = 0.7) +
  scale_x_continuous(bquote(tau),breaks = seq(0, .4, .1)) +
  scale_y_continuous(expand = c(0.1, 0)) +
  scale_colour_manual(values = c("#00429d", "#35739a", "#3aa794", "#c8004c", "#93003a")) +
  theme(text = element_text(size = 12, family = ffont)) +
  theme_tufte(base_size = 12, base_family = ffont) +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        strip.text.y = element_text(angle = 45),
        legend.position = c(.9,.15))
```

## Density

```{r integrals2}
gdwide2    <- gdlong[, ..colms5]
setkey(gdwide, Session)

gdints2    <- gdwide2[, lapply(.SD, MESS::auc, x = threshold, type = 'spline'),
                    by = .(Study.ID, Session), .SDcols = metrics]
```

```{r repmeslplot2}
repmeslp2  <- function(metric_str, data = gdplots2){
  ggplot(data, aes_string(y = metric_str)) +
    geom_point(data = data[Session == "T-1"], aes(x = x_j),
               shape = 21, size = 1, fill = "white", alpha = 0.9,
               color = "#00429d") +
    geom_point(data = data[Session == "T0"], aes(x = x_j),
               shape = 21, size = 1, fill = "white", alpha = 0.9,
               color = "#35739a") +
    geom_point(data = data[Session == "T1"], aes(x = x_j),
               shape = 21, size = 1, fill = "white", alpha = 0.9,
               color = "#3aa794") +
    geom_point(data = data[Session == "T2"], aes(x = x_j),
               shape = 21, size = 1, fill = "white", alpha = 0.9,
               color = "#c8004c") +
    geom_point(data = data[Session == "T3"], aes(x = x_j),
               shape = 21, size = 1, fill = "white", alpha = 0.9,
               color = "#93003a") +
    geom_line(aes(x = x_j, group = Study.ID), color = "lightgray", alpha = .4) +
    geom_violin(data = data[Session == "T-1"], aes(x = x),
                position = position_nudge(x = 0), fill = "#00429d",
                color = "white", alpha = .1, trim = FALSE) +
    geom_violin(data = data[Session == "T0"], aes(x = x),
                position = position_nudge(x = 0), fill = "#35739a",
                color = "white", alpha = .1, trim = FALSE) +
    geom_violin(data = data[Session == "T1"], aes(x = x),
                position = position_nudge(x = 0), fill = "#3aa794",
                color = "white", alpha = .1, trim = FALSE) +
    geom_violin(data = data[Session == "T2"], aes(x = x),
                position = position_nudge(x = 0), fill = "#c8004c",
                color = "white", alpha = .1, trim = FALSE) +
    geom_violin(data = data[Session == "T3"], aes(x = x),
                position = position_nudge(x = 0), fill = "#93003a",
                color = "white", alpha = .1, trim = FALSE) +
    #Define additional settings
    scale_x_continuous(breaks=c(1,2,3,4,5),
                       labels=c("Before sham", "Before active",
                                "2 weeks", "3 months", "6 months"),
                        limits=c(0.5, 5.5)) +
    ylab(TeX(paste0("$\\int_{0.02}^{0.4} ", metric_str, "(\\tau) d_{\\tau}"))) +
    theme_tufte(base_size = 12, base_family = ffont) +
    theme(axis.title.x = element_blank(),
          # axis.text.y = element_blank(),
          axis.ticks = element_blank())
}
```

```{r}
gdplots2   <- copy(gdints2)
gdplots2[
  Session == "T-1", x := 1][
  Session == "T0", x := 2][
  Session == "T1", x := 3][
  Session == "T2", x := 4][
  Session == "T3", x := 5]
gdplots2[, x_j  := jitter(x, amount = .09)]

repmeslp2("density")
```

```{r lrtl-density}
afex::mixed(density ~ Session + FD + VAS + BIS + Age + Sex +
                   (1 + Session|Study.ID) + (1|threshold),
                 data = gdmod2, method = 'LRT')
```

```{r lmerl-density, results = "asis"}
mod <- lme4::lmer(density ~ Session +
                    (1+Session|Study.ID) + (1|threshold),
                  data = gdmod2)
stargazer::stargazer(mod, header = FALSE, title = "(\\#tab:lmerl-density) Longitudinal Mixed Effects Model for Density.")
```





```{r density-plots2, fig.cap = "A) Individual slopes across thresholds; B) Model's predicted slopes", fig.height = 9, fig.pos="p"}
gdm  <- copy(gdmod2)
gdm[, pred_dist := fitted(mod)]

p1 <- ggplot(gdm, aes(Session, density, group = Study.ID, colour = Session)) +
  geom_point(shape = 21, size = 1, stroke = .3, fill = "white") +
  geom_line(size = 0.25) +
  ylab(TeX("Density by $\\tau$")) +
  theme_tufte(base_size = 12, base_family = ffont) +
  scale_colour_manual(values = c("#00429d", "#35739a", "#3aa794", "#c8004c", "#93003a")) +
  facet_wrap(vars(threshold), scales = "free_y") +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        legend.position = "none")

p2 <- ggplot(gdm[threshold == 0.4],
             aes(Session, pred_dist, group = Study.ID, colour = Session)) +
  geom_point(shape = 21, size = 1.5, fill = "white") +
  geom_line(size = 0.25) +
  ylab("Predicted slopes: Density") +
  theme_tufte(base_size = 12, base_family = ffont) +
  scale_colour_manual(values = c("#00429d", "#35739a", "#3aa794", "#c8004c", "#93003a")) +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank())

cowplot::plot_grid(p1, p2, labels = "AUTO", nrow = 2)
```


## Strength

```{r}
repmeslp2(metrics[2])
```

```{r lrtl-strength}
afex::mixed(strength ~ Session + FD + VAS + BIS + Age + Sex +
                   (1 + Session|Study.ID) + (1|threshold),
                 data = gdmod2, method = 'LRT')
```

```{r lmerl-strength, results = "asis"}
mod <- lme4::lmer(strength ~ Session +
                    (1+Session|Study.ID) + (1|threshold),
                  data = gdmod2)
stargazer::stargazer(mod, header = FALSE, title = "(\\#tab:lmerl-strength) Longitudinal Mixed Effects Model for Strength.")
```





```{r strength-plots2, fig.cap = "A) Individual slopes across thresholds; B) Model's predicted slopes", fig.height = 9, fig.pos="p"}
gdm  <- copy(gdmod2)
gdm[, pred_dist := fitted(mod)]

p1 <- ggplot(gdm, aes(Session, strength, group = Study.ID, colour = Session)) +
  geom_point(shape = 21, size = 1, stroke = .3, fill = "white") +
  geom_line(size = 0.25) +
  ylab(TeX("Strength by $\\tau$")) +
  theme_tufte(base_size = 12, base_family = ffont) +
  scale_colour_manual(values = c("#00429d", "#35739a", "#3aa794", "#c8004c", "#93003a")) +
  facet_wrap(vars(threshold), scales = "free_y") +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        legend.position = "none")

p2 <- ggplot(gdm[threshold == 0.4],
             aes(Session, pred_dist, group = Study.ID, colour = Session)) +
  geom_point(shape = 21, size = 1.5, fill = "white") +
  geom_line(size = 0.25) +
  ylab("Predicted slopes: Strength") +
  theme_tufte(base_size = 12, base_family = ffont) +
  scale_colour_manual(values = c("#00429d", "#35739a", "#3aa794", "#c8004c", "#93003a")) +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank())

cowplot::plot_grid(p1, p2, labels = "AUTO", nrow = 2)
```

## Modularity

```{r}
repmeslp2(metrics[3])
```

```{r lrtl-mod}
afex::mixed(mod.wt ~ Session + FD + VAS + BIS + Age + Sex +
                   (1 + Session|Study.ID) + (1|threshold),
                 data = gdmod2, method = 'LRT')
```

```{r lmerl-mod, results = "asis"}
mod <- lme4::lmer(mod.wt ~ Session + FD +
                    (1+Session|Study.ID) + (1|threshold),
                  data = gdmod2)
stargazer::stargazer(mod, header = FALSE, title = "(\\#tab:lmerl-mod) Longitudinal Mixed Effects Model for Modularity.")
```



```{r mod-plots2, fig.cap = "A) Individual slopes across thresholds; B) Model's predicted slopes", fig.height = 9}
gdm  <- copy(gdmod2)
gdm[, pred_dist := fitted(mod)]

p1 <- ggplot(gdm, aes(Session, mod.wt, group = Study.ID, colour = Session)) +
  geom_point(shape = 21, size = 1, stroke = .3, fill = "white") +
  geom_line(size = 0.25) +
  ylab(TeX("Modularity by $\\tau$")) +
  theme_tufte(base_size = 12, base_family = ffont) +
  scale_colour_manual(values = c("#00429d", "#35739a", "#3aa794", "#c8004c", "#93003a")) +
  facet_wrap(vars(threshold), scales = "free_y") +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        legend.position = "none")

p2 <- ggplot(gdm[threshold == 0.4],
             aes(Session, pred_dist, group = Study.ID, colour = Session)) +
  geom_point(shape = 21, size = 1.5, fill = "white") +
  geom_line(size = 0.25) +
  ylab("Predicted slopes: Modularity") +
  theme_tufte(base_size = 12, base_family = ffont) +
  scale_colour_manual(values = c("#00429d", "#35739a", "#3aa794", "#c8004c", "#93003a")) +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank())

cowplot::plot_grid(p1, p2, labels = "AUTO", nrow = 2)
```

## Number of hubs

```{r}
repmeslp2(metrics[4])
```

```{r lrtl-nhubs}
afex::mixed(num.hubs.wt ~ Session + FD + VAS + BIS + Age + Sex +
                   (1 + Session|Study.ID) + (1|threshold),
                 data = gdmod2, method = 'LRT')
```

```{r lmerl-nhubs, results = "asis"}
mod <- lme4::lmer(num.hubs.wt ~ Session + BIS +
                    (1+Session|Study.ID) + (1|threshold),
                  data = gdmod2)
stargazer::stargazer(mod, header = FALSE, title = "(\\#tab:lmerl-nhubs) Longitudinal Mixed Effects Model for Number of hubs.")
```



```{r nhubs-plots2, fig.cap = "A) Individual slopes across thresholds; B) Model's predicted slopes", fig.height = 9}
gdm  <- copy(gdmod2[!(Study.ID == "sub-012" & Session == "T1")])
gdm[, pred_dist := fitted(mod)]

p1 <- ggplot(gdm, aes(Session, num.hubs.wt, group = Study.ID, colour = Session)) +
  geom_point(shape = 21, size = 1, stroke = .3, fill = "white") +
  geom_line(size = 0.25) +
  ylab(TeX("Number of hubs by $\\tau$")) +
  theme_tufte(base_size = 12, base_family = ffont) +
  scale_colour_manual(values = c("#00429d", "#35739a", "#3aa794", "#c8004c", "#93003a")) +
  facet_wrap(vars(threshold), scales = "free_y") +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        legend.position = "none")

p2 <- ggplot(gdm[threshold == 0.4],
             aes(Session, pred_dist, group = Study.ID, colour = Session)) +
  geom_point(shape = 21, size = 1.5, fill = "white") +
  geom_line(size = 0.25) +
  ylab("Predicted slopes: Number of hubs") +
  theme_tufte(base_size = 12, base_family = ffont) +
  scale_colour_manual(values = c("#00429d", "#35739a", "#3aa794", "#c8004c", "#93003a")) +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank())

cowplot::plot_grid(p1, p2, labels = "AUTO", nrow = 2)
```

## Global efficiency

```{r}
repmeslp2("E.global")
```

```{r lrtl-eglob}
afex::mixed(E.global ~ Session + FD + VAS + BIS + Age + Sex +
                   (1 + Session|Study.ID) + (1|threshold),
                 data = gdmod2, method = 'LRT')
```

```{r lmerl-eglob, results = "asis"}
mod <- lme4::lmer(E.global ~ Session + BIS +
                    (1+Session|Study.ID) + (1|threshold),
                  data = gdmod2)
stargazer::stargazer(mod, header = FALSE, title = "(\\#tab:lmerl-nhubs) Longitudinal Mixed Effects Model for Global Efficiency.")
```



```{r eglob-plots2, fig.cap = "A) Individual slopes across thresholds; B) Model's predicted slopes", fig.height = 9}
gdm  <- copy(gdmod2[!(Study.ID == "sub-012" & Session == "T1")])
gdm[, pred_dist := fitted(mod)]

p1 <- ggplot(gdm, aes(Session, E.global, group = Study.ID, colour = Session)) +
  geom_point(shape = 21, size = 1, stroke = .3, fill = "white") +
  geom_line(size = 0.25) +
  ylab(TeX("Global efficiency by $\\tau$")) +
  theme_tufte(base_size = 12, base_family = ffont) +
  scale_colour_manual(values = c("#00429d", "#35739a", "#3aa794", "#c8004c", "#93003a")) +
  facet_wrap(vars(threshold), scales = "free_y") +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        legend.position = "none")

p2 <- ggplot(gdm[threshold == 0.4],
             aes(Session, pred_dist, group = Study.ID, colour = Session)) +
  geom_point(shape = 21, size = 1.5, fill = "white") +
  geom_line(size = 0.25) +
  ylab("Predicted slopes: Global efficiency") +
  theme_tufte(base_size = 12, base_family = ffont) +
  scale_colour_manual(values = c("#00429d", "#35739a", "#3aa794", "#c8004c", "#93003a")) +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank())

cowplot::plot_grid(p1, p2, labels = "AUTO", nrow = 2)
```


## Global efficiency (weighted)

```{r}
repmeslp2("E.global.wt")
```

```{r lrtl-eglobw}
afex::mixed(E.global.wt ~ Session + FD + VAS + BIS + Age + Sex +
                   (1 + Session|Study.ID) + (1|threshold),
                 data = gdmod2, method = 'LRT')
```



```{r lmerl-eglobw, results = "asis"}
mod <- lme4::lmer(E.global.wt ~ Session + Sex +
                    (1+Session|Study.ID) + (1|threshold),
                  data = gdmod2)
stargazer::stargazer(mod, header = FALSE, title = "(\\#tab:lmerl-nhubs) Longitudinal Mixed Effects Model for Global Efficiency (weighted).")
```

```{r eglobw-plots2, fig.cap = "A) Individual slopes across thresholds; B) Model's predicted slopes", fig.height = 9}
gdm  <- copy(gdmod2)
gdm[, pred_dist := fitted(mod)]

p1 <- ggplot(gdm, aes(Session, E.global.wt, group = Study.ID, colour = Session)) +
  geom_point(shape = 21, size = 1, stroke = .3, fill = "white") +
  geom_line(size = 0.25) +
  ylab(TeX("Global efficiency (weighted) by $\\tau$")) +
  theme_tufte(base_size = 12, base_family = ffont) +
  scale_colour_manual(values = c("#00429d", "#35739a", "#3aa794", "#c8004c", "#93003a")) +
  facet_wrap(vars(threshold), scales = "free_y") +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        legend.position = "none")

p2 <- ggplot(gdm[threshold == 0.4],
             aes(Session, pred_dist, group = Study.ID, colour = Session)) +
  geom_point(shape = 21, size = 1.5, fill = "white") +
  geom_line(size = 0.25) +
  ylab("Predicted slopes: Global efficiency (weighted)") +
  theme_tufte(base_size = 12, base_family = ffont) +
  scale_colour_manual(values = c("#00429d", "#35739a", "#3aa794", "#c8004c", "#93003a")) +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank())

cowplot::plot_grid(p1, p2, labels = "AUTO", nrow = 2)
```

## Local efficiency

```{r}
repmeslp2("E.local")
```

```{r lrtl-eloc}
afex::mixed(E.local ~ Session + FD + VAS + BIS + Age + Sex +
                   (1 + Session|Study.ID) + (1|threshold),
                 data = gdmod2, method = 'LRT')
```



```{r lmerl-eloc, results = "asis"}
mod <- lme4::lmer(E.local ~ Session +
                    (1+Session|Study.ID) + (1|threshold),
                  data = gdmod2)
stargazer::stargazer(mod, header = FALSE, title = "(\\#tab:lmerl-nhubs) Longitudinal Mixed Effects Model for Local Efficiency.")
```

```{r eloc-plots2, fig.cap = "A) Individual slopes across thresholds; B) Model's predicted slopes", fig.height = 9}
gdm  <- copy(gdmod2)
gdm[, pred_dist := fitted(mod)]

p1 <- ggplot(gdm, aes(Session, E.local, group = Study.ID, colour = Session)) +
  geom_point(shape = 21, size = 1, stroke = .3, fill = "white") +
  geom_line(size = 0.25) +
  ylab(TeX("Local efficiency by $\\tau$")) +
  theme_tufte(base_size = 12, base_family = ffont) +
  scale_colour_manual(values = c("#00429d", "#35739a", "#3aa794", "#c8004c", "#93003a")) +
  facet_wrap(vars(threshold), scales = "free_y") +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        legend.position = "none")

p2 <- ggplot(gdm[threshold == 0.4],
             aes(Session, pred_dist, group = Study.ID, colour = Session)) +
  geom_point(shape = 21, size = 1.5, fill = "white") +
  geom_line(size = 0.25) +
  ylab("Predicted slopes: Local efficiency") +
  theme_tufte(base_size = 12, base_family = ffont) +
  scale_colour_manual(values = c("#00429d", "#35739a", "#3aa794", "#c8004c", "#93003a")) +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank())

cowplot::plot_grid(p1, p2, labels = "AUTO", nrow = 2)
```


## Local efficiency (weighted)

```{r}
repmeslp2("E.local.wt")
```

```{r lrtl-elocw}
afex::mixed(E.local.wt ~ Session + FD + VAS + BIS + Age + Sex +
                   (1 + Session|Study.ID) + (1|threshold),
                 data = gdmod2, method = 'LRT')
```

```{r lmerl-elocw, eval=F, results = "asis"}
mod <- lme4::lmer(E.local.wt ~ Session + Sex +
                    (1+Session|Study.ID) + (1|threshold),
                  data = gdmod2)
stargazer::stargazer(mod, header = FALSE, title = "(\\#tab:lmerl-nhubs) Longitudinal Mixed Effects Model for Local Efficiency (weighted).")
```



```{r elocw-plots2, eval=F, fig.cap = "A) Individual slopes across thresholds; B) Model's predicted slopes", fig.height = 9}
gdm  <- copy(gdmod2)
gdm[, pred_dist := fitted(mod)]

p1 <- ggplot(gdm, aes(Session, E.local.wt, group = Study.ID, colour = Session)) +
  geom_point(shape = 21, size = 1, stroke = .3, fill = "white") +
  geom_line(size = 0.25) +
  ylab(TeX("Local efficiency (weighted) by $\\tau$")) +
  theme_tufte(base_size = 12, base_family = ffont) +
  scale_colour_manual(values = c("#00429d", "#35739a", "#3aa794", "#c8004c", "#93003a")) +
  facet_wrap(vars(threshold), scales = "free_y") +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        legend.position = "none")

p2 <- ggplot(gdm[threshold == 0.4],
             aes(Session, pred_dist, group = Study.ID, colour = Session)) +
  geom_point(shape = 21, size = 1.5, fill = "white") +
  geom_line(size = 0.25) +
  ylab("Predicted slopes: Local efficiency (weighted)") +
  theme_tufte(base_size = 12, base_family = ffont) +
  scale_colour_manual(values = c("#00429d", "#35739a", "#3aa794", "#c8004c", "#93003a")) +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank())

cowplot::plot_grid(p1, p2, labels = "AUTO", nrow = 2)
```

## Local efficiency (weighted) without outlier

```{r}
repmeslp2("E.local.wt",
          gdplots2[!(Study.ID %in% c("sub-010", "sub-024") & Session == "T1")])
```

```{r lrtl-elocw2}
afex::mixed(E.local.wt ~ Session + FD + VAS + BIS + Age + Sex +
                   (1 + Session|Study.ID) + (1|threshold),
            data = gdmod2[!(Study.ID %in% c("sub-010", "sub-024") & Session == "T1")],
            method = 'LRT')
```

## Clustering coefficient

```{r}
repmeslp2("Cp.norm")
```

```{r lrtl-cp}
afex::mixed(Cp.norm ~ Session + FD + VAS + BIS + Age + Sex +
                   (1 + Session|Study.ID) + (1|threshold),
                 data = gdmod2, method = 'LRT')
```

```{r lmerl-cp, results = "asis"}
mod <- lme4::lmer(Cp.norm ~ Session + BIS + Sex +
                    (1+Session|Study.ID) + (1|threshold),
                  data = gdmod2)
stargazer::stargazer(mod, header = FALSE, title = "(\\#tab:lmerl-nhubs) Longitudinal Mixed Effects Model for Clustering Coefficient.")
```



```{r cp-plots2, fig.cap = "A) Individual slopes across thresholds; B) Model's predicted slopes", fig.height = 9}
gdm  <- copy(gdmod2[!(Study.ID == "sub-012" & Session == "T1")])
gdm[, pred_dist := fitted(mod)]

p1 <- ggplot(gdm, aes(Session, Cp.norm, group = Study.ID, colour = Session)) +
  geom_point(shape = 21, size = 1, stroke = .3, fill = "white") +
  geom_line(size = 0.25) +
  ylab(TeX("Clustering coefficient by $\\tau$")) +
  theme_tufte(base_size = 12, base_family = ffont) +
  scale_colour_manual(values = c("#00429d", "#35739a", "#3aa794", "#c8004c", "#93003a")) +
  facet_wrap(vars(threshold), scales = "free_y") +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        legend.position = "none")

p2 <- ggplot(gdm[threshold == 0.4],
             aes(Session, pred_dist, group = Study.ID, colour = Session)) +
  geom_point(shape = 21, size = 1.5, fill = "white") +
  geom_line(size = 0.25) +
  ylab("Predicted slopes: Clustering coefficient") +
  theme_tufte(base_size = 12, base_family = ffont) +
  scale_colour_manual(values = c("#00429d", "#35739a", "#3aa794", "#c8004c", "#93003a")) +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank())

cowplot::plot_grid(p1, p2, labels = "AUTO", nrow = 2)
```

## Characteristic path length

```{r}
repmeslp2("Lp.norm")
```

```{r lrtl-lp}
afex::mixed(Lp.norm ~ Session + FD + VAS + BIS + Age + Sex +
                   (1 + Session|Study.ID) + (1|threshold),
                 data = gdmod2, method = 'LRT')
```

```{r lmerl-lp, results = "asis"}
mod <- lme4::lmer(Lp.norm ~ Session + Age +
                    (1+Session|Study.ID) + (1|threshold),
                  data = gdmod2)
stargazer::stargazer(mod, header = FALSE, title = "(\\#tab:lmerl-nhubs) Longitudinal Mixed Effects Model for Characteristic Path Length.")
```



```{r lp-plots2, fig.cap = "A) Individual slopes across thresholds; B) Model's predicted slopes", fig.height = 9}
gdm  <- copy(gdmod2)
gdm[, pred_dist := fitted(mod)]

p1 <- ggplot(gdm, aes(Session, Lp.norm, group = Study.ID, colour = Session)) +
  geom_point(shape = 21, size = 1, stroke = .3, fill = "white") +
  geom_line(size = 0.25) +
  ylab(TeX("Characteristic Path Length by $\\tau$")) +
  theme_tufte(base_size = 12, base_family = ffont) +
  scale_colour_manual(values = c("#00429d", "#35739a", "#3aa794", "#c8004c", "#93003a")) +
  facet_wrap(vars(threshold), scales = "free_y") +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        legend.position = "none")

p2 <- ggplot(gdm[threshold == 0.4],
             aes(Session, pred_dist, group = Study.ID, colour = Session)) +
  geom_point(shape = 21, size = 1.5, fill = "white") +
  geom_line(size = 0.25) +
  ylab("Predicted slopes: Characteristic Path Length") +
  theme_tufte(base_size = 12, base_family = ffont) +
  scale_colour_manual(values = c("#00429d", "#35739a", "#3aa794", "#c8004c", "#93003a")) +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank())

cowplot::plot_grid(p1, p2, labels = "AUTO", nrow = 2)
```


## Smallworldness

```{r}
repmeslp2("sigma")
```

```{r lrtl-sw}
afex::mixed(sigma ~ Session + FD + VAS + BIS + Age + Sex +
                   (1 + Session|Study.ID) + (1|threshold),
                 data = gdmod2, method = 'LRT')
```

```{r lmerl-sw, results = "asis"}
mod <- lme4::lmer(sigma ~ Session +
                    (1+Session|Study.ID) + (1|threshold),
                  data = gdmod2)
stargazer::stargazer(mod, header = FALSE, title = "(\\#tab:lmerl-nhubs) Longitudinal Mixed Effects Model for Smallworldness.")
```





```{r sw-plots2, fig.cap = "A) Individual slopes across thresholds; B) Model's predicted slopes", fig.height = 9, fig.pos="p"}
gdm  <- copy(gdmod2)
gdm[, pred_dist := fitted(mod)]

p1 <- ggplot(gdm, aes(Session, sigma, group = Study.ID, colour = Session)) +
  geom_point(shape = 21, size = 1, stroke = .3, fill = "white") +
  geom_line(size = 0.25) +
  ylab(TeX("Smallworldness by $\\tau$")) +
  theme_tufte(base_size = 12, base_family = ffont) +
  scale_colour_manual(values = c("#00429d", "#35739a", "#3aa794", "#c8004c", "#93003a")) +
  facet_wrap(vars(threshold), scales = "free_y") +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        legend.position = "none")

p2 <- ggplot(gdm[threshold == 0.4],
             aes(Session, pred_dist, group = Study.ID, colour = Session)) +
  geom_point(shape = 21, size = 1.5, fill = "white") +
  geom_line(size = 0.25) +
  ylab("Predicted slopes: Smallworldness") +
  theme_tufte(base_size = 12, base_family = ffont) +
  scale_colour_manual(values = c("#00429d", "#35739a", "#3aa794", "#c8004c", "#93003a")) +
  theme(axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank())

cowplot::plot_grid(p1, p2, labels = "AUTO", nrow = 2)
```
